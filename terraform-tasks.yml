parameters: 
  ARM_RG_NAME: 'Default Resource Group'
  ARM_CONTAINER_NAME: 'Default Container'
  ARM_SA_NAME: 'Default Storage account'
  ARM_KEY: 'Default Key'
  ARM_SUBSCRIPTION_ID: 'Default Subscription ID'
  ARM_CLIENT_ID: 'Default App ID'
  ARM_TENANT_ID: 'Default Tenant ID'
  ARM_CLIENT_SECRET: 'Default App password'

- job: TerraformInit
  steps:
    - bash: |
        terraform init -reconfigure -backend-config="container_name=${{ parameters.ARM_CONTAINER_NAME }}" \
        -backend-config="storage_account_name=${{ parameters.ARM_SA_NAME }}" \
        -backend-config="subscription_id=${{ parameters.ARM_SUBSCRIPTION_ID }}" \
        -backend-config="tenant_id=${{ parameters.ARM_TENANT_ID }}" \
        -backend-config="client_id=${{ parameters.ARM_CLIENT_ID }}" \
        -backend-config="client_secret=${{ parameters.ARM_CLIENT_SECRET }}" \
        -backend-config="resource_group_name=${{ parameters.ARM_RG_NAME }}" \
        -backend-config="key=${{ parameters.ARM_KEY }}" \
        -input=false

- job: TerraformPlan
  dependsOn: "TerraformInit"
  steps:
    - bash: |
        terraform init -reconfigure -backend-config="container_name=${{ parameters.ARM_CONTAINER_NAME }}" \
        -backend-config="storage_account_name=${{ parameters.ARM_SA_NAME }}" \
        -backend-config="subscription_id=${{ parameters.ARM_SUBSCRIPTION_ID }}" \
        -backend-config="tenant_id=${{ parameters.ARM_TENANT_ID }}" \
        -backend-config="client_id=${{ parameters.ARM_CLIENT_ID }}" \
        -backend-config="client_secret=${{ parameters.ARM_CLIENT_SECRET }}" \
        -backend-config="resource_group_name=${{ parameters.ARM_RG_NAME }}" \
        -backend-config="key=${{ parameters.ARM_KEY }}" \
        -input=false
        terraform plan -out=tfplan -input=false

- job: waitForValidation
  pool: server
  displayName: Wait for external validation
  dependsOn: "TerraformPlan"
  timeoutInMinutes: 4320 # job times out in 3 days
  steps:
  - task: ManualValidation@0
    timeoutInMinutes: 1440 # task times out in 1 day
    inputs:
      notifyUsers: |
        juan.orozco@jalasoft.com
      instructions: 'Please validate the build configuration and resume'
      onTimeout: 'resume'

- job: TerraformApply 
  displayName: Terraform Apply
  dependsOn: "waitForValidation"
  steps: 
    - bash: |
        terraform init -reconfigure -backend-config="container_name=${{ parameters.ARM_CONTAINER_NAME }}" \
        -backend-config="storage_account_name=${{ parameters.ARM_SA_NAME }}" \
        -backend-config="subscription_id=${{ parameters.ARM_SUBSCRIPTION_ID }}" \
        -backend-config="tenant_id=${{ parameters.ARM_TENANT_ID }}" \
        -backend-config="client_id=${{ parameters.ARM_CLIENT_ID }}" \
        -backend-config="client_secret=${{ parameters.ARM_CLIENT_SECRET }}" \
        -backend-config="resource_group_name=${{ parameters.ARM_RG_NAME }}" \
        -backend-config="key=${{ parameters.ARM_KEY }}" \
        -input=false
        terraform apply -auto-approve
      